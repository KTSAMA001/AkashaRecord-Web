# =============================================
# 阿卡西记录 Nginx 配置
# 适用于宝塔面板
# 
# 使用方式：
#   宝塔面板 → 网站 → 添加站点 → 配置文件中替换内容
#   或直接复制到 /www/server/panel/vhost/nginx/ 下
#
# 请将 YOUR_DOMAIN 替换为实际域名（如 akasha.ktsama.top）
# 请将 /www/wwwroot/AkashaRecord-Web 替换为实际项目路径
# =============================================

server {
    listen 80;
    server_name YOUR_DOMAIN;

    # SSL 配置（宝塔申请免费证书后自动添加，也可手动配置）
    # listen 443 ssl http2;
    # ssl_certificate    /www/server/panel/vhost/cert/YOUR_DOMAIN/fullchain.pem;
    # ssl_certificate_key /www/server/panel/vhost/cert/YOUR_DOMAIN/privkey.pem;

    # 网站根目录 → VitePress 构建输出
    root /www/wwwroot/AkashaRecord-Web/.vitepress/dist;
    index index.html;

    # ====== 访问日志 ======
    access_log /www/wwwlogs/akasha.log;
    error_log /www/wwwlogs/akasha.error.log;

    # ====== 静态资源缓存 ======
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # VitePress 带 hash 的资源文件（长期缓存）
    location /assets/ {
        expires 365d;
        add_header Cache-Control "public, immutable";
    }

    # ====== API 数据文件（短缓存）======
    location /api/ {
        expires 5m;
        add_header Cache-Control "public";
    }

    # ====== Webhook 反向代理 ======
    location /webhook {
        proxy_pass http://127.0.0.1:3721;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 10s;
        proxy_read_timeout 30s;

        # 限制 webhook 请求体大小
        client_max_body_size 10m;
    }

    # ====== VitePress Clean URLs ======
    # 处理无扩展名 URL → 尝试 .html
    location / {
        try_files $uri $uri.html $uri/ /index.html;
    }

    # ====== 安全配置 ======
    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # 禁止访问 node_modules
    location /node_modules/ {
        deny all;
    }

    # ====== Gzip 压缩 ======
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types
        text/plain
        text/css
        text/javascript
        application/javascript
        application/json
        application/xml
        image/svg+xml;
}
